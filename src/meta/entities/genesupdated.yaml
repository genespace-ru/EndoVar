genesupdated:
  type: table
  displayName: Genes
  order: '10'
  primaryKey: ID
  scheme:
    columns:
    - ID:
        type: KEYTYPE
        autoIncrement: true
        primaryKey: true
        doc: Gene internal identifier.
    - ncbi_gene_ID:
        type: VARCHAR(20)
        doc: NCBI gene ID
    - HGNC:
        type: VARCHAR(20)
        doc: The HGNC approved gene symbol.
    - name:
        type: VARCHAR(100)
        doc: Gene name from HGNC.
    - summary:
        type: VARCHAR(1900)
        canBeNull: true
        doc: extract of gene summary texts for genes that have them
    - ensembl_gene_id:
        type: VARCHAR(20)
        canBeNull: true
        doc: Ensembl gene ID
    - refseq_accession:
        type: VARCHAR(20)
        canBeNull: true
        doc: RefSeq nucleotide accession(s)
    - uniprot_ids:
        type: VARCHAR(20)
        canBeNull: true
        doc: UniProt protein accession
    - omim_id:
        type: VARCHAR(20)
        canBeNull: true
        doc: Online Mendelian Inheritance in Man (OMIM) ID
    - orphanet:
        type: VARCHAR(20)
        canBeNull: true
        doc: Orphanet ID
    - mane_select:
        type: VARCHAR(50)
        canBeNull: true
        doc: NCBI and Ensembl transcript IDs/acessions including the version number for one high-quality representative transcript per protein-coding gene that is well-supported by experimental data and represents the biology of the gene. The IDs are delimited by |.
    - gain_CNV:
        type: INT
        doc: patients count with gain_CNV with gene   
    - loss_CNV:
        type: INT
        doc: patients count with loss_CNV with gene 
    - CNV_qty:
        type: INT
        doc: all patients count with CNV with gene 
    - CNV_patients_diagnosis:
        type: VARCHAR(10000)
        doc: list of patients diagnosis
  queries:

    - '*** Selection view ***':
        type: 1D
        roles: '@AllRoles'
        code: |
            SELECT 
                ID AS "Code",
                HGNC AS "Name"
            FROM genesupdated

    - All records:
        type: 1D
        roles: '@AllRoles'
        layout: '{"topForm":"GenesFilter", "quickType":"select"}'
        operations:
        - GenesFilter
        code: |
            SELECT 
                HGNC AS "HGNC",
                CONCAT('%', HGNC, '%') AS "___HGNC",
                'Copy number gain' AS "___gain",
                'Copy number loss' AS "___loss",
                name, 
                summary AS "summary;<quick visible='true' />",
                ensembl_gene_id AS "Ensembl ID;<quick visible='true' />",
                refseq_accession AS "Refseq;<quick visible='true' />",
                uniprot_ids AS "Uniprot;<quick visible='true' />",
                omim_id AS "OMIM ID;<quick visible='true' />",
                orphanet AS "Orphanet;<quick visible='true' />", 
                mane_select AS "MANE_SELECT;<quick visible='true' />",

                '<sql using="___HGNC">SELECT count(*) FROM cnvsfinal WHERE genes LIKE ? </sql>'   
                AS "CNV All classes;<quick visible='true' />",
                '<link table="cnvsfinal" using="HGNC" columns="Genes" />' AS ";CNV All classes",
                CNV_patients_diagnosis AS "CNV_patient_diagnosis;<quick visible='true' />",

                '<sql using="___HGNC,___gain">SELECT count(*) FROM cnvsfinal c 
                 WHERE genes LIKE ? AND status = ? </sql>'     
                AS "CNV Duplications;<quick visible='true' />",
                '<link table="cnvsfinal" using="HGNC,___gain" columns="Genes,status" />' AS ";CNV Duplications",

                '<sql using="___HGNC,___gain">SELECT STRING_AGG(SUBSTRING(patients_diagnosis, 1, POSITION('-' IN patients_diagnosis) -1), '<br>') FROM cnvsfinal 
                 WHERE genes LIKE ? AND status = ?</sql>'   
                AS "CNV gain classes;<quick visible='true' />",                

                '<sql using="___HGNC,___loss">SELECT count(*) FROM cnvsfinal c 
                 WHERE genes LIKE ? AND status = ? </sql>'     
                AS "CNV Deletions;<quick visible='true' />",
                '<link table="cnvsfinal" using="HGNC,___loss" columns="Genes,status" />' AS ";CNV Deletions",

                '<sql using="___HGNC,___loss">SELECT STRING_AGG(SUBSTRING(patients_diagnosis, 1, POSITION('-' IN patients_diagnosis) -1), '<br>') FROM cnvsfinal 
                 WHERE genes LIKE ? AND status = ?</sql>'   
                AS "CNV loss classes;<quick visible='true' />",

                '<sql using="HGNC">SELECT count(*) FROM itogsnvs t 
                 WHERE t.G = ? </sql>' 
                AS "SNV;<quick visible='true' />",
                '<link table="itogsnvs" using="HGNC" columns="G" />' AS ";SNV", 

                '<sql using="___HGNC">SELECT Ds FROM itogsnvs
                 WHERE itogsnvs.G LIKE ? </sql>'   
                AS "Snv diagnosis;<quick visible='true' />"

            FROM genesupdated gup

            WHERE (1=1)
            <if parameter="HGNC">
              AND gup.HGNC LIKE '<parameter:HGNC/>%'
            </if>
            <if parameter="DiagnosisCNVs">
              AND gup.CNV_patients_diagnosis LIKE '%<parameter:DiagnosisCNVs/>%'
            </if> 
            <if parameter="DiagnosisSNVs">
              AND itogsnvs.Ds LIKE '%<parameter:DiagnosisSNVs/>%'
            </if> 
            ORDER BY HGNC            


#    - Card:
 #       layout: '{"tableBox":"gene", "mode":"named", "hideTitle":"true"}'
 #       invisible: true
  #      roles: "@AllRoles"
  #      code: |-
  #          SELECT
  #              ID AS "ID"
  #          FROM genes

 #   - Info:
 #       roles: "@AllRoles"
 #       layout: '{"tableBox":"geneInfo", "mode":"named", "filterUI":"no", "hideTitle":"true"}'
  #          SELECT
  #              name
   #         FROM genes

  operations:
  - GenesFilter:
      type: Groovy
      roles: '@AllRoles'
      file: operations.filters.GenesFilter.groovy

